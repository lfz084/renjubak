<!DOCTYPE html>
<html>

<head>
    <title>test</title>
    <style type="text/css">
        #root {
            position: relative;
        }

        #wrapper {
            background-color: #dddddd;
            width: 800px;
            height: 1200px;
            overflow-x: hidden;
            overflow-y: scroll;
            position: fixed;
            left: 0px;
            top: 50px;
            -webkit-overflow-scrolling: touch;
        }

        div {
            height: 0px;
            position: relative;
        }

        #console {
            position: fixed;
            z-index: 99;
        }

        iframe {
            overflow: scroll;
            background-color: white;
            border-width: 0px;
            width: 100%;
            height: 100%;
            position: relative;
            left: 0px;
            top: 0px;
            z-index: 0;
        }

        button {
            font-size: 30px;
            position: fixed;
            width: 80px;
            height: 50px;
            top: 30px;
            z-index: 1;
        }

        button.one {

            left: 0px;
        }

        button.two {

            left: 100px;
        }

        button.three {

            left: 200px;
        }

        button.top {

            left: 300px;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <iframe name="helpWindow" id="iframe" src="power.html"></iframe>
    </div>
    <script>
        const IFREAM_DIV = document.getElementById("wrapper")
        const IFREAM = document.getElementById("iframe")
        const CHILD_WINDOW = IFREAM.contentWindow;
        let getDocumentHeight = () => {};
        let getScrollPoints = () => {};

        const focusElement = (() => {
            const LINK = document.createElement("a");
            document.body.appendChild(LINK);
            return (id) => {
                LINK.href = "power.html" + id;
                LINK.target = "helpWindow";
                LINK.click();
            }
        })();


        document.body.onload = () => {

            setView();

            getDocumentHeight = (() => { //添加结束标记，准确判断文档高度

                let iDoc = IFREAM.Document || IFREAM.contentWindow.document;
                const MARK_END = iDoc.createElement("a");
                iDoc.body.appendChild(MARK_END);
                return () => {
                    return CHILD_WINDOW.getAbsolutePos(MARK_END).y;
                }
            })();

            getScrollPoints = CHILD_WINDOW.getScrollPoints;
            if (navigator.userAgent.indexOf("iPhone") + 1) {
                //CHILD_WINDOW.scrollToAnimation = scrollToAnimation;
                CHILD_WINDOW.setScrollY = setScrollY;
                CHILD_WINDOW.getScrollY = getScrollY;
                const temp = CHILD_WINDOW.scrollToAnimation;
                CHILD_WINDOW.scrollToAnimation = (top)=>{
                    console.log(">>>parent animationFrameScroll")
                    IFREAM.style.height = getDocumentHeight() + "px";
                    temp(top);
                }
            }
        }


/*
        const scrollToAnimation = (() => {

            let moves = [];
            let animationFrameScroll = null;
            let targetScrollTop = 0
            let tempScrollTop = 0;

            function scrollTo() {

                let IFREAM = document.getElementById("iframe");
                let iDoc = IFREAM.Document || IFREAM.contentWindow.document;
                //console.log(`scrollHeight=${iDoc.body.scrollHeight},\ndocumentHeight=${getDocumentHeight()}`)
                tempScrollTop += moves.splice(0, 1)[0];
                setScrollY(tempScrollTop);
                if (moves.length) {
                    animationFrameScroll = requestAnimationFrame(scrollTo);
                }
                else {
                    cancelAnima();
                }
            }

            function cancelAnima() {

                cancelAnimationFrame(animationFrameScroll);
                moves = [];
                animationFrameScroll = null;
                targetScrollTop = 0
                tempScrollTop = 0;
            }

            return (top) => {

                console.log("parent animationFrameScroll")
                IFREAM.style.height = getDocumentHeight() + "px";
                cancelAnima();
                targetScrollTop = top;
                tempScrollTop = IFREAM_DIV.scrollTop;
                moves = getScrollPoints(targetScrollTop - tempScrollTop);
                scrollTo();
            };
        })();
*/


        function getScrollY() {

            return IFREAM_DIV.scrollTop;
        }


        function setScrollY(top) {
            console.log(`IFREAM_DIV setScrollY, ${top}`)
            IFREAM_DIV.scrollTop = top;
        }


        function setView(width = 800) {

            const ELEM_LIST = document.getElementsByName("viewport");
            console.log(ELEM_LIST)
            const VIEW = ELEM_LIST[0] || document.createElement("meta");
            console.log(VIEW)
            let dw = document.documentElement.clientWidth;
            let dh = document.documentElement.clientHeight;
            let sw = window.screen.width;
            let sh = window.screen.height;
            let max = sw > sh ? sw : sh;
            let min = sw < sh ? sw : sh;
            let scale = (dw > dh ? max : min) / width;
            document.head.appendChild(VIEW);
            VIEW.setAttribute("name", "viewport");
        }
    </script>
</body>

</html>