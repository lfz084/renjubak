<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-store">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="摆棋小工具">
    <meta name="x5-page-mode" content="app">
    <link rel="shortcut icon" sizes="128x128" href="https://lfz084.github.io/icon.png">
    <link rel="apple-touch-icon" href="https://lfz084.github.io/icon.png">
    <link rel="icon" href="https://lfz084.github.io/icon.ico">
    <title> 摆棋小工具</title>
    <style>
        #mlog {
            text-align: center;
            width: 100%;
            opacity: 0.3;
        }

        .refresh {
            font-size: 100px;
            opacity: 0.93;
            position: absolute;
            top: 100px;
        }
    </style>
</head>

<body>
    <div id="mlog"></div>
    <script>
        let re1 = /\?(v|V)\=/;
        window.reloadApp = function() {
            window.onbeforeunload = null;
            window.location.href = window.location.href.split("?")[0] + "?v=" + new Date().getTime();
        };
        let oldTime = window.location.href.split(re1)[2] || 0;
        if ((new Date().getTime() - oldTime) / 1000 > 300) {
            reloadApp();
        }
    </script>
    <script language="javascript">
        // updata 
        "use strict";
        window.APP_VERSION = "v1202.00";
        window.URL_VERSION = "?v=" + window.APP_VERSION;
        window.CHECK_VERSION = true;
        window.SOURCE_FILES = {
            loaders: "style/loaders.css",
            main: "style/main.css",
            PFSCMedium1_woff: "style/font/PFSCMedium1.woff",
            PFSCMedium1_ttf: "style/font/PFSCMedium1.ttf",
            PFSCHeavy1_ttf: "style/font/PFSCHeavy1.ttf",
            PFSCHeavy1_woff: "style/font/PFSCHeavy1.woff",
            viewport: "script/viewport-0821.js",
            vconsole: "script/vConsole/vconsole.min.js",
            button: "script/button-0821.js",
            emoji: "script/emoji-0821.js",
            checkerBoard: "script/checkerBoard-0821.js",
            control: "script/control_0821.js",
            msgbox: "script/msgbox-0821.js",
            appData: "script/appData-0821.js",
            Evaluator: "script/Evaluator-0821.js",
            engine: "script/engine-0821.js",
            NoSleep: "script/NoSleep.min.js",
            jspdf: "script/jsPDF/jspdf.umd_01.js",
            PFSCMedium: "script/jsPDF/PFSCMedium.js",
            PFSCHeavy: "script/jsPDF/PFSCHeavy.js",
            worker: "script/worker-0821.js",
            '404_html': "./404.html",
            renju_html: "./renju.html",
            renju_js: "./renju-0821.js",
            "close_svg": "./pic/close.svg",
            "chevron-left_svg": "./pic/chevron-left.svg",
            "close-white_svg": "./pic/close-white.svg",
            "docusign-white_svg": "./pic/docusign-white.svg",
            "icon_png": "https://lfz084.github.io/icon.png",
            "icon_ico": "https://lfz084.github.io/icon.ico",

            IntervalPost: "script/IntervalPost.js",
            RenjuTree: "script/RenjuTree.js",
            UNICODE2GBK: "./ReadLib/script/UNICODE2GBK.js",
            JFile: "./ReadLib/script/JFile.js",
            JPoint: "./ReadLib/script/JPoint.js",
            LibraryFile: "./ReadLib/script/LibraryFile.js",
            MoveList: "./ReadLib/script/MoveList.js",
            MoveNode: "./ReadLib/script/MoveNode.js",
            Stack: "./ReadLib/script/Stack.js",
            RenLibDoc: "./ReadLib/script/RenLibDoc.js",
            work_ReadLib: "./ReadLib/script/work_ReadLib.js",
            RenjuLib: "./ReadLib/script/RenjuLib.js",
            RenLib_wasm: "./ReadLib/script/RenLib.wasm",
            RenLibDoc_wasm: "./ReadLib/script/RenLibDoc_wasm.js"
        }
        window.SCRIPT_VERSIONS = {
            viewport: "???",
            button: "???",
            emoji: "???",
            checkerBoard: "???",
            control: "???",
            msgbox: "???",
            appData: "???",
            Evaluator: "???",
            engine: "???",
            worker: "???",
            renju: "???"
        };
        window.UPDATA_INFO = {
            "v0912.00": ["更新说明:增加了lib棋谱读取功能，适合读取一些小棋谱。建议打开1MB以下的棋谱，5M以内勉强可以应付。以后会支持打开更大的棋谱"],
            "v0928.02": ["支持lib棋谱增加到 30M",
                         "打开大棋谱时间缩短 30%",
                         "暂时还不支持显示对称点", ],
            "v0929.02": ["更新说明: lib 棋谱已支持显示对称点。之前因为不支持对称点，导致很多棋谱分支显示不完整的bug已被修复。"],
            "v0929.03": ["更新说明: 增加 设置 lib棋谱棋盘大小 的功能。修复了 小棋盘棋谱 不能正确显示对称点的bug"],
            "v1006.00": ["更新内容: 兼容 Rapfi制谱 保存的 lib棋谱。"],
            "v1031.02": ["重写了lib棋谱的解码程序,打开速度不再蜗牛",
                         "已经支持打开 100M 以上的lib棋谱",
                         "调整了部分按键位置"],
            "v1101.03": ["更新内容: 再次优化lib文件打开速度。",
                         "要体验快速模式,需要浏览器支持 WebAssembly"],
            "v1108.03": ["增加设置棋盘大小功能",
                         "增加设置棋盘坐标功能",
                         "暂时只支持15路棋盘计算"],
            "v1111.06": ["增加棋盘放大功能",
                         "长按棋盘边框放大/缩小",
                         "增加退出提示,防止误操作丢失数据"],
            "v1116.05": ["增加设置按钮位置功能",
                         "你可以保存5个按钮布局"],
            "v1202.00": ["修复了,浏览lib棋谱时,部分节点丢失文字标记的bug"]
        }
        window.checkScriptVersion = function(filename) {
            return new Promise((resolve, reject) => {
                let ver = self.SCRIPT_VERSIONS[filename];
                mlog(`[index] \n>> checkScriptVersion \n[${[filename, ver || "undefined"]}]`);
                if (ver && (ver != window.APP_VERSION)) {
                    const ERR = `reload`;
                    const ASK = `版本号不一致，可能影响正常运行\n_____________________\n\n${strLen("主页", 25)}版本号: ${window.APP_VERSION} \n${strLen(filename + ".js", 25)}版本号: ${self.SCRIPT_VERSIONS[filename]} \n_____________________\n\n`;
                    const PS = `是否更新？\n\n${strLen("",15)}[取消] = 不更新${strLen("",10)}[确定] = 更新`;
                    if (window.CHECK_VERSION && confirm(ASK + PS)) {
                        removeAppCache()
                            .then(() => {
                                reject(ERR)
                            })
                    }
                    else {
                        resolve();
                    }
                    window.CHECK_VERSION = false;
                }
                else {
                    resolve();
                }
            });
        }
        window.checkAppVersion = function() {
            return new Promise((resolve, reject) => {
                mlog("checkAppVersion ...")
                if ("localStorage" in window) {
                    const OLD_VERDION = localStorage.getItem("RENJU_APP_VERSION");
                    if (OLD_VERDION != window.APP_VERSION) {
                        removeAppCache()
                            .then(() => {
                                mlog("renju.html removeAppCache ...")
                                resolve();
                            })
                            .catch(() => {
                                resolve();
                            })
                    }
                    else {
                        resolve();
                    }
                }
                else {
                    resolve();
                }
            })
        }
        window.removeAppCache = function() {
            return new Promise((resolve, reject) => {
                let removeCaches, removeLocalStorage;
                if (caches) {
                    removeCaches = caches.keys().then(function(cacheNames) {
                        return Promise.all(
                            cacheNames.map(function(cacheName) {
                                return caches.delete(cacheName);
                            })
                        );
                    })
                }
                else {
                    removeCaches = Promise.resolve()
                }
                if ("localStorage" in window) {
                    removeLocalStorage = Promise.resolve().then(() => {
                        localStorage.removeItem("RENJU_APP_VERSION");
                        localStorage.removeItem("debug")
                    })
                }
                else {
                    removeLocalStorage = Promise.resolve()
                }
                Promise.all([removeCaches, removeLocalStorage]).then(resolve).catch(resolve)
            })
        }
        window.postVersion = function() {
            return new Promise((resolve, reject) => {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    let timer;
                    navigator.serviceWorker.onmessage = function(event) {
                        const MSG = event.data;
                        if (MSG.type == "NEW_VERSION" && MSG.version == window.APP_VERSION) {
                            mlog("[NEW_VERSION]");
                            rm();
                        }
                        else {
                            mlog(`[${MSG}]`);
                        }
                    }

                    function rm() {
                        navigator.serviceWorker.onmessage = undefined;
                        clearTimeout(timer);
                        resolve();
                    }
                    navigator.serviceWorker.controller.postMessage({ type: "NEW_VERSION", version: window.APP_VERSION });
                    timer = setTimeout(() => {
                        mlog("postVersion Timeout");
                        rm();
                    }, 30 * 1000);
                }
                else {
                    resolve();
                }
            })
        }
    </script>
    <script>
        const BUT = document.getElementById("mlog");
        let mlog = (function() {
            let timer;
            return function(message) {
                if (timer) clearTimeout(timer);
                if (!BUT.parentNode) return;
                BUT.innerHTML = message;
                BUT.removeAttribute("class");
                console.log(message);
                timer = setTimeout(() => {
                    BUT.innerHTML = `<a href="renju.html" target="_self">点击刷新</a>`;
                    BUT.setAttribute("class", "refresh")
                }, 15 * 1000)
            }
        })()
        let removeMlog = function() {
            if (BUT && BUT.parentNode) BUT.parentNode.removeChild(BUT);
        }

        function strLen(str, len, char = " ", align = "left") {
            if (align == "left") {
                return (str + new Array(len).join(char)).slice(0, len)
            }
            else {
                return (new Array(len).join(char) + str).slice(-len)
            }
        }

        document.body.onload = () => {
            function _loadScript(url) { //加载脚本
                url = url.split("?")[0] + window.URL_VERSION;
                const filename = url.split("/").pop().split("?")[0];
                return new Promise((resolve, reject) => {
                    let oHead = document.getElementsByTagName('HEAD').item(0);
                    let oScript = document.createElement("script");
                    oHead.appendChild(oScript);
                    oScript.type = "text/javascript";
                    oScript.rel = "preload";
                    oScript.as = "script";
                    oScript.onload = () => {
                        let message = `_loadScript: "${filename}"`;
                        setTimeout(() => {
                            resolve(message);
                        }, 0);
                    }
                    oScript.onerror = (err) => {
                        let message = `_loadScript_Error: "${filename}"`;
                        reject(message);
                    }
                    oScript.src = url;
                });
            }
            mlog(`body onload`)
            window.DEBUG = true;
            mlog("postVersion ......");
            postVersion()
                .then(() => {
                    mlog("checkAppVersion ......");
                    return checkAppVersion()
                })
                .then(() => {
                    mlog("load App ......");
                    return _loadScript(SOURCE_FILES["renju_js"])
                })
                .then(() => {
                    mlog("loadApp source ......");
                    return loadApp()
                })
                .then(() => {
                    //testEv(testMoveIdx);
                    //testEv(testGetArrValue);
                    //testEv(testIfSwitch, 1000);
                    //testEv(testGetPower);
                    /*
                    testEv(({codeStr, inputStr}) => {
                        testFunctionTime([testLineFour, testLineFoul, testLineThree, testLine], inputStr * 1);
                    });
                    */
                
                    cBoard.onMove = function(idx) {
                        try {
                            let arr = /*cBoard.getArray2D()*/cBoard.getArray(),
                                newarr = getArr2D([]),
                                markArr = new Array(225);
                            cBoard.cleLb("all");
                            /*
                            let st = new Date().getTime();
                            for (let i = 0; i < 20000; i++) {
                                //isLineThree(7, 7, "x", 1, arr);
                                //findFourPoint(arr, arr[idx], newarr);
                                findFour(arr, arr[idx], markArr);
                            }
                            alert(new Date().getTime() - st);
                            
                            for (let i = 0; i < 225; i++) {
                                let mark = markArr[i];
                                if (MAX & mark) {
                                    let txt = (mark & MAX) >> 1,
                                        color = (mark & FREE_COUNT) ? "red" : "black";
                                    cBoard.wLb(i, txt, color);
                                }
                            }
                            */
                            
                            for (let idx=0; idx<225; idx++) {
                                if (0 == arr[idx]){
                                    //console.log(`${idxToName(idx)}, isFoul=${isFoul(idx, arr)}`)
                                    if(isFoul(idx, arr)) cBoard.wLb(idx, "X", "red");
                                }
                            }
                            
                            return;
                            for (let idx=0; idx<225; idx++) {
                                if (0 == arr[idx]) continue;
                            for (let direction = 0; direction < 4; direction++) {
                                let ps = [],
                                    rt = testLine(idx, direction, arr[idx], arr),
                                    num = ((MAX & rt) >> 1) + 1,
                                    free = FREE & rt,
                                    markMove = 7 & rt >> 5,
                                    freeCount = 7 & rt >> 8;
                                
                                if (0 == arr[idx] || SHORT == (MAX & rt) || 1 == arr[idx] && FOUL & rt) continue;
                                
                                console.log(FOUL_MAX_FREE & rt)
                                if (/*FOUR_NOFREE == (MAX & rt)*/THREE_FREE == (FOUL_MAX_FREE & rt)){
                                    console.info(`idx=${idxToName(idx)}, direction=${direction}`)
                                    //ps[0] = 1;
                                    //ps[1] = getBlockFourPoint(idx, arr, rt);
                                    ps = getFreeFourPoint(idx, arr, rt);
                                }
                                
                                console.log(`ps = ${ps}`)
                                for(let i=ps[0]; i>0; i--) {
                                    cBoard.wLb(ps[i], 4, "red");
                                }
                                
                                /*
                                for (let m = 0; m >= -4 - freeCount; m--) {
                                    let newIdx = moveIdx(idx, m + markMove, direction);
                                    if (0 == arr[newIdx]) {
                                        ps.push(newIdx);
                                    }
                                }
                                

                                ps.length && cBoard.wLb(ps[0], num, "black");
                                for (let i = ps.length - 2; i >= 1; i--) {
                                    let color = free ? "red" : "black";
                                    cBoard.wLb(ps[i], num, color);
                                }
                                ps.length > 1 && cBoard.wLb(ps[ps.length - 1], num, "black");
                                */
                            }
                            }
                            
                        }
                        catch (err) {
                            alert(`${err.message}\n${err.Stack}`)
                        }
                    }

                })
                .catch((err) => {
                    const MSG = "❌" + "打开网页出错, 准备刷新" + "\n\n" + err;
                    alert(MSG)
                    removeAppCache()
                        .then(() => {
                            window.reloadApp()
                        })
                        .catch(() => {
                            window.reloadApp()
                        })
                })
        };
    </script>
    <script>
        /*
        let idxLists;
        
        function createEmptyLists() {
            let outIdx = 225,
                idxLists = [];
            for (let i = 0; i < 2; i++) {
                idxLists[i] = [];
                for (let j = 0; j < 15; j++) {
                    idxLists[i][j] = [];
                    for (let k = 0; k < 15 + 8; k++) {
                        idxLists[i][j][k] = outIdx;
                    }
                }
            }

            for (let i = 2; i < 4; i++) {
                idxLists[i] = [];
                for (let j = 0; j < 15; j++) {
                    idxLists[i][j] = [];
                    for (let k = 0; k < 1 + 8 + j; k++) {
                        idxLists[i][j][k] = outIdx;
                    }
                }
                for (let j = 13; j >= 0; j--) {
                    idxLists[i][28 - j] = [];
                    for (let k = 0; k < 1 + 8 + j; k++) {
                        idxLists[i][28 - j][k] = outIdx;
                    }
                }
            }
            return idxLists;
        }

        function createIdxLists(cBoardSize) {
            let List,
                idxLists = createEmptyLists();

            for (let y = 0; y < 15; y++) {
                List = idxLists[0][y];
                for (let x = 0; x < 15; x++) {
                    if (x < cBoardSize && y < cBoardSize) List[4 + x] = x + y * 15;
                }
            }

            for (let x = 0; x < 15; x++) {
                List = idxLists[1][x];
                for (let y = 0; y < 15; y++) {
                    if (x < cBoardSize && y < cBoardSize) List[4 + y] = x + y * 15;
                }
            }

            for (let i = 0; i < 15; i++) { // x + (14-y) = i, y = x + 14 - i
                List = idxLists[2][i];
                for (let j = 0; j <= i; j++) {
                    let x = 0 + j,
                        y = x + 14 - i;
                    if (x < cBoardSize && y < cBoardSize) List[4 + j] = x + y * 15;
                }
            }
            for (let i = 13; i >= 0; i--) { // (14-x) + y = i, y = i - 14 + x;
                List = idxLists[2][14 + 14 - i];
                for (let j = 0; j <= i; j++) {
                    let x = 14 - i + j,
                        y = i - 14 + x;
                    if (x < cBoardSize && y < cBoardSize) List[4 + j] = x + y * 15;
                }
            }

            for (let i = 0; i < 15; i++) { // x + y = i, y = i - x
                List = idxLists[3][i];
                for (let j = 0; j <= i; j++) {
                    let x = i - j,
                        y = i - x;
                    if (x < cBoardSize && y < cBoardSize) List[4 + j] = x + y * 15;
                }
            }
            for (let i = 13; i >= 0; i--) { // (14-x)+(14-y) = i, y = 28 - i - x
                List = idxLists[3][14 + 14 - i];
                for (let j = 0; j <= i; j++) {
                    let x = 14 - j,
                        y = 28 - i - x;
                    if (x < cBoardSize && y < cBoardSize) List[4 + j] = x + y * 15;
                }
            }
            return idxLists;
        }

        function idxLists2String() {
            let str = "";
            for (let i = 0; i < idxLists.length; i++) {
                str += `\n${i}:`;
                for (let j = 0; j < idxLists[i].length; j++) {
                    str += `\n[${idxLists[i][j]}],`;
                }
            }
            return str;
        }


        function moveIdx(idx, move = 0, direction = 0) {
            try{
            let x = getX(idx),
                y = getY(idx);
            switch (direction) {
                case 0:
                    return idxLists[direction][y][4 + x + move];
                    break;
                case 1:
                    return idxLists[direction][x][4 + y + move];
                    break;
                case 2:
                    return idxLists[direction][x + 14 - y][x + 14 - y < 15 ? 4 + x + move : 4 + y + move];
                    break;
                case 3:
                    return idxLists[direction][x + y][x + y < 15 ? 4 + y + move : 18 - x + move];
                    break;
            }
            }
            catch(err){
                alert(err.Stack || err.message)
            }
        }
        
        function getArrayValue(idx, move, direction, arr){
            return arr[moveIdx(idx, move, direction)];
        }
        */

        function testEv(fun, time = 5000) {
            setTimeout(() => {
                input()
                    .then(fun)
                    .then(() => {
                        testEv(fun, time);
                    })
            }, time)
        }

        function testIf(value, value1) {
            if (value == 0) {
                return false;
            }
            else if (value == 1 && 1 == value1) {
                return true;
            }
            else if (value == 2 && 2 == value1) {
                return true;
            }
            else if (value == -1) {
                return false;
            }
            return false;
        }

        function testSwitch(value, value1) {
            switch (value) {
                case 0:
                    return false;
                    break;
                case 1:
                    if (1 == value1) return true;
                    else return false;
                    break;
                case 2:
                    if (2 == value1) return true;
                    else return false;
                    break;
                case -1:
                    return false;
                    break;
                default:
                    return false;
            }
        }

        function testIfSwitch({ butCode, inputStr }) {
            inputStr = parseInt(inputStr);
            let startTime;
            startTime = new Date().getTime();
            for (let i = 0; i < inputStr; i++) {
                testSwitch(1, -1)
            }
            alert("testSwitch:" + (new Date().getTime() - startTime));

            startTime = new Date().getTime();
            for (let i = 0; i < inputStr; i++) {
                testIf(1, -1)
            }
            alert("testIf:" + (new Date().getTime() - startTime));
        }

        function testGetPower({ butCode, inputStr }) {
            let ps = [];
            for (let direction = 0; direction < 4; direction++) {
                ps.push(getPower(inputStr * 1, cBoard.getArray(), direction, 1));
            }
            alert(`${ps}`);
        }

        function testFunctionTime(funs, loop) {
            try {
                let times = [],
                    ts = [],
                    names = [],
                    lineInfoStr = [],
                    arr = cBoard.getArray(),
                    arr2D = cBoard.getArray2D(),
                    lineInfo = new Uint32Array(4),
                    startTime = 0;
                for (let f = 0; f < funs.length; f++) {
                    startTime = new Date().getTime();
                    for (let i = 0; i < loop; i++) {
                        for (let idx = 0; idx < 225; idx++) {
                            for (let direction = 0; direction < 4; direction++) {
                                ts[direction] = funs[f](idx, direction, 1, arr);
                            }
                        }
                    }
                    times[f] = `${funs[f].name}: ${new Date().getTime() - startTime}`;
                }

                alert(`${times.join("\n")}`)
            }
            catch (err) {
                alert(err.message)
            }
        }

        function input() {
            return msg({
                text: "112",
                type: "input",
                lineNum: 1,
                butNum: 1
            })
        }

        function testMoveIdx({ butCode, inputStr }) {
            let startTime = new Date().getTime();

            inputStr = parseInt(inputStr);
            for (let i = 0; i < inputStr; i++) {
                for (let direction = 0; direction < 4; direction++) {
                    for (let move = -14; move < 15; move++) {
                        moveIdx(112, move, direction);
                    }
                }
            }

            alert(new Date().getTime() - startTime);
        }

        function testGetArrValue({ butCode, inputStr }) {
            let str = "";
            inputStr = parseInt(inputStr);

            for (let direction = 0; direction < 4; direction++) {
                str += "[";
                for (let move = -5; move < 6; move++) {
                    //str += `${moveIdx(inputStr, move, direction)},`;
                    str += `${getArrValue(inputStr, move, direction, cBoard.getArray())},`;
                }
                str += "]\n";
            }
            alert(str)
        }
    </script>
</body>

</html>