<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-store">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="摆棋小工具">
    <meta name="x5-page-mode" content="app">
    <link rel="shortcut icon" sizes="128x128" href="https://lfz084.github.io/icon.png">
    <link rel="apple-touch-icon" href="https://lfz084.github.io/icon.png">
    <link rel="icon" href="https://lfz084.github.io/icon.ico">
    <title> 摆棋小工具</title>
    <style>
        #mlog {
            text-align: center;
            width: 100%;
            opacity: 0.3;
        }

        .refresh {
            font-size: 100px;
            opacity: 0.93;
            position: absolute;
            top: 100px;
        }
    </style>
</head>

<body>
    <div id="mlog"></div>
    <script>
        let re1 = /\?(v|V)\=/;
        window.reloadApp = function() {
            window.location.href = window.location.href.split("?")[0] + "?v=" + new Date().getTime();
        }
        let oldTime = window.location.href.split(re1)[2] || 0;
        if ((new Date().getTime() - oldTime) / 1000 > 300) {
            reloadApp();
        }
    </script>
    <script language="javascript">
        // updata 
        "use strict";
        window.APP_VERSION = "v0929.03";
        window.URL_VERSION = "?v=" + window.APP_VERSION;
        window.CHECK_VERSION = true;
        window.SOURCE_FILES = {
            loaders: "style/loaders.css",
            main: "style/main.css",
            PFSCMedium1_woff: "style/font/PFSCMedium1.woff",
            PFSCMedium1_ttf: "style/font/PFSCMedium1.ttf",
            PFSCHeavy1_ttf: "style/font/PFSCHeavy1.ttf",
            PFSCHeavy1_woff: "style/font/PFSCHeavy1.woff",
            viewport: "script/viewport-0821.js",
            vconsole: "script/vConsole/vconsole.min.js",
            button: "script/button-0821.js",
            emoji: "script/emoji-0821.js",
            checkerBoard: "script/checkerBoard-0821.js",
            control: "script/control_0821.js",
            msgbox: "script/msgbox-0821.js",
            appData: "script/appData-0821.js",
            Evaluator: "script/Evaluator-0821.js",
            engine: "script/engine-0821.js",
            NoSleep: "script/NoSleep.min.js",
            jspdf: "script/jsPDF/jspdf.umd_01.js",
            PFSCMedium: "script/jsPDF/PFSCMedium.js",
            PFSCHeavy: "script/jsPDF/PFSCHeavy.js",
            worker: "script/worker-0821.js",
            '404_html': "./404.html",
            renju_html: "./renju.html",
            renju_js: "./renju-0821.js",
            "close.svg": "./pic/close.svg",
            "chevron-left.svg": "./pic/chevron-left.svg",
            "close-white.svg": "./pic/close-white.svg",
            "docusign-white.svg": "./pic/docusign-white.svg",
            "icon.png": "https://lfz084.github.io/icon.png",
            "icon.ico": "https://lfz084.github.io/icon.ico",

            IntervalPost: "script/IntervalPost.js",
            RenjuTree: "script/RenjuTree.js",
            UNICODE2GBK: "./ReadLib/script/UNICODE2GBK.js",
            JFile: "./ReadLib/script/JFile.js",
            JPoint: "./ReadLib/script/JPoint.js",
            LibraryFile: "./ReadLib/script/LibraryFile.js",
            MoveList: "./ReadLib/script/MoveList.js",
            MoveNode: "./ReadLib/script/MoveNode.js",
            Stack: "./ReadLib/script/Stack.js",
            RenLibDoc: "./ReadLib/script/RenLibDoc.js",
            work_ReadLib: "./ReadLib/script/work_ReadLib.js",
            RenjuLib: "./ReadLib/script/RenjuLib.js"
        }
        window.SCRIPT_VERSIONS = {
            viewport: "???",
            button: "???",
            emoji: "???",
            checkerBoard: "???",
            control: "???",
            msgbox: "???",
            appData: "???",
            Evaluator: "???",
            engine: "???",
            worker: "???",
            renju: "???"
        };
        window.UPDATA_INFO = {
            "v0912.00": ["更新说明:增加了lib棋谱读取功能，适合读取一些小棋谱。建议打开1MB以下的棋谱，5M以内勉强可以应付。以后会支持打开更大的棋谱"],
            "v0928.02": ["支持lib棋谱增加到 30M",
                         "打开大棋谱时间缩短 30%",
                         "暂时还不支持显示对称点",],
            "v0929.02": ["更新说明: lib 棋谱已支持显示对称点。之前因为不支持对称点，导致很多棋谱分支显示不完整的bug已被修复。"],
            "v0929.03": ["更新说明: 增加 设置 lib棋谱棋盘大小 的功能。修复了 小棋盘棋谱 不能正确显示对称点的bug"]
        }
        window.checkScriptVersion = function(filename) {
            return new Promise((resolve, reject) => {
                let ver = self.SCRIPT_VERSIONS[filename];
                mlog(`[index] \n>> checkScriptVersion \n[${[filename, ver || "undefined"]}]`);
                if (ver && (ver != window.APP_VERSION)) {
                    const ERR = `reload`;
                    const ASK = `版本号不一致，可能影响正常运行\n_____________________\n\n${strLen("主页", 25)}版本号: ${window.APP_VERSION} \n${strLen(filename + ".js", 25)}版本号: ${self.SCRIPT_VERSIONS[filename]} \n_____________________\n\n`;
                    const PS = `是否更新？\n\n${strLen("",15)}[取消] = 不更新${strLen("",10)}[确定] = 更新`;
                    if (window.CHECK_VERSION && confirm(ASK + PS)) {
                        removeAppCache()
                            .then(() => {
                                reject(ERR)
                            })
                    }
                    else {
                        resolve();
                    }
                    window.CHECK_VERSION = false;
                }
                else {
                    resolve();
                }
            });
        }
        window.checkAppVersion = function() {
            return new Promise((resolve, reject) => {
                mlog("checkAppVersion ...")
                if ("localStorage" in window) {
                    const OLD_VERDION = localStorage.getItem("RENJU_APP_VERSION");
                    if (OLD_VERDION != window.APP_VERSION) {
                        removeAppCache()
                            .then(() => {
                                mlog("renju.html removeAppCache ...")
                                resolve();
                            })
                            .catch(() => {
                                resolve();
                            })
                    }
                    else {
                        resolve();
                    }
                }
                else {
                    resolve();
                }
            })
        }
        window.removeAppCache = function() {
            return new Promise((resolve, reject) => {
                let removeCaches, removeLocalStorage;
                if (caches) {
                    removeCaches = caches.keys().then(function(cacheNames) {
                        return Promise.all(
                            cacheNames.map(function(cacheName) {
                                return caches.delete(cacheName);
                            })
                        );
                    })
                }
                else {
                    removeCaches = Promise.resolve()
                }
                if ("localStorage" in window) {
                    removeLocalStorage = Promise.resolve().then(() => {
                        localStorage.removeItem("RENJU_APP_VERSION");
                        localStorage.removeItem("debug")
                    })
                }
                else {
                    removeLocalStorage = Promise.resolve()
                }
                Promise.all([removeCaches, removeLocalStorage]).then(resolve).catch(resolve)
            })
        }
        window.postVersion = function() {
            return new Promise((resolve, reject) => {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    let timer;
                    navigator.serviceWorker.onmessage = function(event) {
                        const MSG = event.data;
                        if (MSG.type == "NEW_VERSION" && MSG.version == window.APP_VERSION) {
                            mlog("[NEW_VERSION]");
                            rm();
                        }
                        else {
                            mlog(`[${MSG}]`);
                        }
                    }

                    function rm() {
                        navigator.serviceWorker.onmessage = undefined;
                        clearTimeout(timer);
                        resolve();
                    }
                    navigator.serviceWorker.controller.postMessage({ type: "NEW_VERSION", version: window.APP_VERSION });
                    timer = setTimeout(() => {
                        mlog("postVersion Timeout");
                        rm();
                    }, 30 * 1000);
                }
                else {
                    resolve();
                }
            })
        }
    </script>
    <script>
        const BUT = document.getElementById("mlog");
        let mlog = (function() {
            let timer;
            return function(message) {
                if (timer) clearTimeout(timer);
                BUT.innerHTML = message;
                BUT.removeAttribute("class");
                console.log(message);
                timer = setTimeout(() => {
                    BUT.innerHTML = `<a href="renju.html" target="_self">点击刷新</a>`;
                    BUT.setAttribute("class", "refresh")
                }, 15 * 1000)
            }
        })()

        function strLen(str, len, char = " ", align = "left") {
            if (align == "left") {
                return (str + new Array(len).join(char)).slice(0, len)
            }
            else {
                return (new Array(len).join(char) + str).slice(-len)
            }
        }

        document.body.onload = () => {
            function _loadScript(url) { //加载脚本
                url = url.split("?")[0] + window.URL_VERSION;
                const filename = url.split("/").pop().split("?")[0];
                return new Promise((resolve, reject) => {
                    let oHead = document.getElementsByTagName('HEAD').item(0);
                    let oScript = document.createElement("script");
                    oHead.appendChild(oScript);
                    oScript.type = "text/javascript";
                    oScript.rel = "preload";
                    oScript.as = "script";
                    oScript.onload = () => {
                        let message = `_loadScript: "${filename}"`;
                        setTimeout(() => {
                            resolve(message);
                        }, 0);
                    }
                    oScript.onerror = (err) => {
                        let message = `_loadScript_Error: "${filename}"`;
                        reject(new Error(message));
                    }
                    oScript.src = url;
                });
            }
            mlog(`body onload`)
            window.DEBUG = true;
            mlog("postVersion ......");
            postVersion()
                .then(() => {
                    mlog("checkAppVersion ......");
                    return checkAppVersion()
                })
                .then(() => {
                    mlog("load App ......");
                    return _loadScript(SOURCE_FILES["renju_js"])
                })
                .then(() => {
                    mlog("loadApp source ......")
                    return loadApp()
                })
                .then(() => {
                    if (BUT && BUT.parentNode) BUT.parentNode.removeChild(BUT);
                })
                .catch((err) => {
                    const MSG = "❌" + "打开网页出错, 准备刷新" + "\n\n" + err;
                    alert(MSG)
                    removeAppCache()
                        .then(() => {
                            window.reloadApp()
                        })
                        .catch(() => {
                            window.reloadApp()
                        })
                })
        };
    </script>
</body>

</html>