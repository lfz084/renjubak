<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-store">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="摆棋小工具">
    <meta name="x5-page-mode" content="app">
    <link rel="shortcut icon" sizes="128x128" href="https://lfz084.github.io/icon.png">
    <link rel="apple-touch-icon" href="https://lfz084.github.io/icon.png">
    <link rel="icon" href="https://lfz084.github.io/icon.ico">
    <title> 摆棋小工具</title>
</head>

<body>
    <p id="butRefresh"><a href="renju.html" target="_self">刷新</a></p>
    <script language="javascript">
        // updata 
        "use strict";

        function strLen(str, len, char = " ") {
            return (str + new Array(len).join(char)).slice(0, len)
        }
        window.APP_VERSION = "v0815.1";
        window.CHECK_VERSION = true;
        window.SCRIPT_VERSION = {
            viewport: 1,
            button: 1,
            emoji: 1,
            checkerBoard: 1,
            control: 1,
            msgbox: 1,
            appData: 1,
            Evaluator: 1,
            engine: 1,
            worker: 1,
            renju: 1
        };
        window.UPDATA_INFO = {
            'v0815.1': [
                "优化了 自动更新功能",
                "修复了几个 BUG",
                "可能又加了几个隐藏的 BUG"
                ]
        }
        window.checkScriptVersion = function(filename) {
            return new Promise((resolve, reject) => {
                let ver = self.SCRIPT_VERSION[filename];
                console.log(`[index] \n>> checkScriptVersion \n[${[filename, ver || "undefined"]}]`);
                if (ver && (ver != window.APP_VERSION)) {
                    const ERR = `reload`;
                    const ASK = `版本号不一致，可能影响正常运行\n_____________________\n\n${strLen("主页", 25)}版本号: ${window.APP_VERSION} \n${strLen(filename + ".js", 25)}版本号: ${self.SCRIPT_VERSION[filename]} \n_____________________\n\n`;
                    const PS = `是否更新？\n\n${strLen("",15)}[取消] = 不更新${strLen("",10)}[确定] = 更新`;

                    if (window.CHECK_VERSION && confirm(ASK + PS)) {
                        removeAppCache()
                            .then(() => {
                                reject(ERR)
                            })
                    }
                    else {
                        resolve();
                    }
                    window.CHECK_VERSION = false;
                    //console.log(ASK);
                }
                else {
                    resolve();
                }
            });
        }
        window.checkAppVersion = function() {
            return new Promise((resolve, reject) => {
                if ("localStorage" in window) {
                    const OLD_VERDION = localStorage.getItem("RENJU_APP_VERSION");
                    if (OLD_VERDION != window.APP_VERSION) {
                        removeAppCache()
                            .then(() => {
                                console.log("renju.html removeAppCache ...")
                                resolve();
                            })
                    }
                    else {
                        resolve();
                    }
                }
                else {
                    resolve();
                }
            })
        }
        window.removeAppCache = function() {
            return new Promise((resolve, reject) => {
                if (caches) {
                    caches.keys().then(function(cacheNames) {
                            return Promise.all(
                                cacheNames.map(function(cacheName) {
                                    return caches.delete(cacheName);
                                })
                            );
                        })
                        .then(resolve)
                        .catch(reject)
                }
                else {
                    resolve();
                }
            })
        }
        window.postVersion = function() {
            return new Promise((resolve, reject) => {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.onmessage = function(event) {
                        const MSG = event.data;
                        if (MSG.type == "NEW_VERSION" && MSG.version == window.APP_VERSION) {
                            rm();
                        }
                    }
                    function rm() {
                        navigator.serviceWorker.onmessage = undefined;
                        resolve();
                    }
                    navigator.serviceWorker.controller.postMessage({ type: "NEW_VERSION", version: window.APP_VERSION });
                    setTimeout(rm, 1000);
                }
                else {
                    resolve();
                }
            })
        }
    </script>
    <script>
        document.body.onload = () => {
            console.log(`body onload`)
            window.DEBUG = true;
            postVersion()
                .then(()=>{
                    //alert("postVersion")
                    return checkAppVersion()
                })
                .then(()=>{
                    //alert("checkAppVersion")
                    return loadApp()
                })
                .then(() => {
                    const BUT = document.getElementById("butRefresh");
                    if (BUT && BUT.parentNode) BUT.parentNode.removeChild(BUT);
                })
                .catch((err)=>{
                    alert(err)
                })
        };
    </script>
    <script src="./renju-0810.js"></script>
</body>

</html>