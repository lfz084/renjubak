<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <style>
        div {
            width: 1000px;
            border: solid #666 0px;
        }

        button {
            font-size: 30px;
            width: 150px;
            height: 50px;
            border: solid black 1px;
        }

        textarea {
            font-size: 25px;
            position: relative;
            left: 25px;
            top: 25px;
            width: 950px;
            height: 1000px;
            border: solid black 1px;
            display: none;
        }

        input {
            display: none;
        }
    </style>
    <script src="./script/UNICODE2GBK.js"></script>
    <script src="./script/GB2312-UTF8.js"></script>
    <script src="./script/UTF8-UTF16.js"></script>
    <script src="./script/JFile.js"></script>
    <script src="./script/JPoint.js"></script>
    <script src="./script/LibraryFile.js"></script>
    <script src="./script/MoveList.js"></script>
    <script src="./script/MoveNode.js"></script>
    <script src="./script/Stack.js"></script>
    <script src="./script/RenLibDoc.js"></script>
    <script src="../script/vConsole/vconsole.min.js"></script>
</head>

<body>
    <div>
        <button id="but_file">loadFile</button>
        <button id="but_text">text</button>
        <button id="but_code">code</button>
        <button id="but_next">next</button>
        <button id="but_8">utf-8</button>
        <button id="but_16">utf-16</button>
        <input id="file" type="file" />
    </div>
    <div>
        <textarea id="textBox">

        </textarea>
    </div>
    <script>
        alert("ver0905.03")
        let charset = "utf-8";
        let xx = new GB2312UTF8();
        let renLibDoc = new CRenLibDoc();


        // source: http://stackoverflow.com/a/11058858
        function ab2str_8(buf) {
            return String.fromCharCode.apply(null, new Uint8Array(buf));
        }

        function ab2str_16(buf) {
            return String.fromCharCode.apply(null, new Uint16Array(buf));
        }

        function str2ab(str) {
            var buf = new ArrayBuffer(str.length * 2); // 2 bytes for each char
            var bufView = new Uint16Array(buf);
            for (var i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }


        let wk = new Worker("./script/work_ReadLib.js")
        alert(wk)
        //wk.postMessage(file);
        wk.onmessage = (e) => {
            console.log(e.data)
        };
        wk.onerror = (e) => {
            alert(`wk err: ${e.message}`)
            wk.terminate();
        }
    </script>
    <script>
        const BUT_FILE = document.getElementById("but_file"),
            BUT_TEXT = document.getElementById("but_text"),
            BUT_CODE = document.getElementById("but_code"),
            BUT_NEXT = document.getElementById("but_next"),
            BUT_8 = document.getElementById("but_8"),
            BUT_16 = document.getElementById("but_16"),
            INPUT_FILE = document.getElementById("file"),
            TEXTBOX = document.getElementById("textBox");
        let arrBuf,
            dataView,
            vConsole,
            m_libfile = new LibraryFile();

        function getArrBuf(file) {
            return new Promise((resolve, reject) => {
                let fr = new FileReader();
                fr.onload = () => {
                    resolve(fr.result);
                }
                fr.onerror = err => {
                    reject(err)
                }
                fr.readAsArrayBuffer(file);
            });
        }
        BUT_8.onclick = () => {
            alert(charset = "utf-8")
        }
        BUT_16.onclick = () => {
            alert(charset = "utf-16")
        }
        BUT_FILE.onclick = () => {
            INPUT_FILE.click()
        };
        BUT_TEXT.onclick = () => {
            TEXTBOX.value = loadAsText();
        };
        BUT_CODE.onclick = () => {
            TEXTBOX.value = loadAsCode();
        };
        BUT_NEXT.onclick = () => {
            let file = INPUT_FILE.files[0];
            wk.postMessage(file);
        };
        INPUT_FILE.onchange = () => {
            let file = INPUT_FILE.files[0];
            wk.postMessage(file);
        }

        function loadAsText(start = 0, end = 100) {
            let txt = "";
            for (let i = start; i < end; i++) {
                txt += String.fromCharCode(dataView.getInt8(i));
            }
            return txt;
        }

        function loadAsCode(start = 0, end = 100) {
            let txt = "";
            for (let i = start; i < end; i++) {
                txt += ("00000000" + dataView.getUint8(i).toString(2)).slice(-8) + " ";
            }
            return txt;
        }

        document.body.onload = () => {
            vConsole = new VConsole();
            //new MoveNode(new MoveNode())
        }
    </script>
</body>

</html>