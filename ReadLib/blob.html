<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <style>
        div {
            width: 1000px;
            border: solid #666 0px;
        }

        button {
            font-size: 30px;
            width: 150px;
            height: 50px;
            border: solid black 1px;
        }

        textarea {
            font-size: 25px;
            position: relative;
            left: 25px;
            top: 25px;
            width: 950px;
            height: 1000px;
            border: solid black 1px;
            display: none;
        }

        input {
            display: none;
        }
    </style>
    <script src="./script/UNICODE2GBK.js"></script>
    <script src="./script/GB2312-UTF8.js"></script>
    <script src="./script/UTF8-UTF16.js"></script>
    <script src="./script/JFile.js"></script>
    <script src="./script/JPoint.js"></script>
    <script src="./script/LibraryFile.js"></script>
    <script src="./script/MoveList.js"></script>
    <script src="./script/MoveNode.js"></script>
    <script src="./script/Stack.js"></script>
    <script src="./script/RenLibDoc.js"></script>
    <script src="../script/vConsole/vconsole.min.js"></script>
</head>

<body>
    <div>
        <button id="but_file">loadFile</button>
        <button id="but_text">text</button>
        <button id="but_code">code</button>
        <button id="but_next">next</button>
        <button id="but_8">utf-8</button>
        <button id="but_16">utf-16</button>
        <input id="file" type="file" />
    </div>
    <div>
        <textarea id="textBox">

        </textarea>
    </div>
    <script>
        alert("ver0905.02")
        let charset = "utf-8";
        let xx = new GB2312UTF8();
        let renLibDoc = new CRenLibDoc();

        /*
        //ArrayBuffer转字符串
        function ab2str(u, f) {
            var b = new Blob([u]);
            var r = new FileReader();
            r.readAsText(b, charset);
            r.onload = function() { if (f) f.call(null, r.result) }
        }*/

        /*
        //字符串转字符串ArrayBuffer
        function str2ab(s, f) {
            var b = new Blob([s], { type: 'text/plain' });
            var r = new FileReader();
            r.readAsArrayBuffer(b);
            r.onload = function() { if (f) f.call(null, r.result) }
        }*/

        // source: http://stackoverflow.com/a/11058858
        function ab2str_8(buf) {
            return String.fromCharCode.apply(null, new Uint8Array(buf));
        }

        function ab2str_16(buf) {
            return String.fromCharCode.apply(null, new Uint16Array(buf));
        }

        function str2ab(str) {
            var buf = new ArrayBuffer(str.length * 2); // 2 bytes for each char
            var bufView = new Uint16Array(buf);
            for (var i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }

        function ReadOldComment(libFile, pStrOneLine, pStrMultiLine) {
            function msb(ch) {
                return (ch & 0x80);
            }

            let buffer = new Uint8Array(2),
                strNew = "";

            pStrOneLine = "";
            pStrMultiLine = "";

            while (true) {
                libFile.Get(buffer);

                //strNew += TCHAR(buffer[0]);

                if (msb(buffer[0])) {
                    break;
                }

                //strNew += TCHAR(buffer[1]);

                if (msb(buffer[1])) {
                    break;
                }
            }
            /*
            Utils::AsciiToWinChar(strNew);

            int n = strNew.Find(TCHAR(8));

            if (n == -1){
                pStrOneLine = strNew;
            }
            else{
                pStrOneLine = strNew.Left(n);
                pStrMultiLine = strNew.Right(strNew.GetLength() - n - 1);
            }
            */
        }

        function ReadNewComment(libFile, pStrOneLine, pStrMultiLine) {
            let buffer = new Uint8Array(2),
                strNew = [];

            strOneLine = "";
            strMultiLine = "";

            while (true) {
                libFile.get(buffer);

                if (buffer[0] == 0) {
                    break;
                }

                strNew.push(buffer[0]);

                if (buffer[1] == 0) {
                    break;
                }

                strNew.push(buffer[1]);
            }
            //console.log(bufferGBK2Unicode(strNew))
            /*
                        int n = strNew.Find(TCHAR(8));

                        if (n == -1)
                        {
                            strOneLine = strNew;
                        }
                        else
                        {
                            strOneLine = strNew.Left(n);
                            strMultiLine = strNew.Right(strNew.GetLength() - n - 1);
                        }*/
        }

        //------------------------------------------------------------------------

        function ReadBoardText(libFile, pStrBoardText) {
            let buffer = new Uint8Array(2);

            pStrBoardText = [];

            while (true) {

                libFile.get(buffer);

                if (buffer[0] == 0) {
                    break;
                }

                pStrBoardText.push(buffer[0]);

                if (buffer[1] == 0) {
                    break;
                }

                pStrBoardText.push(buffer[1]);
            }
            //console.log(bufferGBK2Unicode(pStrBoardText))
            //console.log(pStrBoardText)
            /*
            let bufStr = new Uint8Array(pStrBoardText)
            let code = new Uint16Array([bufStr[0] << 8 | bufStr[1]])
            console.log(code)
            console.log(code[0].toString(16))
            console.log(bufStr)
            let u16 = ab2str_16(bufStr)
            console.log(new Uint16Array(str2ab(u16))[0].toString(16))
            console.log(u16)
            */
        }

        function addLibrary(file) {
            getArrBuf(file)
                .then((buffer) => {
                    arrBuf = buffer;
                    dataView = new DataView(arrBuf);
                    console.log(`open`)
                    if (m_libfile.open(buffer)) {
                        console.log(`open--> end`)
                        if (m_libfile.checkVersion()) {
                            console.log(`checkVersion=true`)
                            return true
                        }
                        else {
                            console.log(`checkVersion=false`)
                            return false
                        }
                    }
                })
                .then((rt) => {
                    let nd = new MoveNode();
                    while (rt && m_libfile.get(nd)) {

                        //console.log(nd)

                        if (nd.isOldComment()) ReadOldComment(m_libfile)

                        if (nd.isNewComment()) ReadNewComment(m_libfile)

                        if (nd.isBoardText()) ReadBoardText(m_libfile)

                        //console.log("<<________________")
                    }
                    alert("finish")
                })
        }
    </script>
    <script>
        const BUT_FILE = document.getElementById("but_file"),
            BUT_TEXT = document.getElementById("but_text"),
            BUT_CODE = document.getElementById("but_code"),
            BUT_NEXT = document.getElementById("but_next"),
            BUT_8 = document.getElementById("but_8"),
            BUT_16 = document.getElementById("but_16"),
            INPUT_FILE = document.getElementById("file"),
            TEXTBOX = document.getElementById("textBox");
        let arrBuf,
            dataView,
            vConsole,
            m_libfile = new LibraryFile();

        function getArrBuf(file) {
            return new Promise((resolve, reject) => {
                let fr = new FileReader();
                fr.onload = () => {
                    resolve(fr.result);
                }
                fr.readAsArrayBuffer(file);
            });
        }
        BUT_8.onclick = () => {
            alert(charset = "utf-8")
        }
        BUT_16.onclick = () => {
            alert(charset = "utf-16")
        }
        BUT_FILE.onclick = () => {
            INPUT_FILE.click()
        };
        BUT_TEXT.onclick = () => {
            TEXTBOX.value = loadAsText();
        };
        BUT_CODE.onclick = () => {
            TEXTBOX.value = loadAsCode();
        };
        BUT_NEXT.onclick = () => {
            renLibDoc.addLibrary(m_libfile)
            /*
            for (let i = 0; i < 20; i++) {
                let nd = new MoveNode();
                console.log("_______get_________")
                if (!m_libfile.get(nd)) break;
                console.log("<<________________")
                console.log(nd)


                if (nd.isOldComment()) {
                    ReadOldComment(m_libfile)
                }

                if (nd.isNewComment()) {
                    ReadNewComment(m_libfile)
                }

                if (nd.isBoardText()) {
                    ReadBoardText(m_libfile)
                }

            }*/
        };
        INPUT_FILE.onchange = () => {
            let file = INPUT_FILE.files[0];

            getArrBuf(file)
                .then((buffer) => {
                    return new Promise((resolve, reject) => {
                        try {
                            console.log(`open`)
                            if (m_libfile.open(buffer)) {
                                console.log(`open--> end`)
                                renLibDoc.addLibrary(m_libfile)
                            }
                            resolve()
                        }
                        catch (err) {
                            reject(err)
                        }
                    })
                })
                .then((rt) => {
                    alert("finish")
                })
                .catch(err => {
                    alert(err)
                    console.error(err.stack)
                })
            //addLibrary(file);
            /*
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({
                    files: [file],
                    title: 'Pictures',
                    text: 'Our Pictures.',
                })
                .then(() => alert('Share was successful.'))
                .catch((error) => alert('Sharing failed', error));
            } else {
                alert(`Your system doesn't support sharing files.`);
            }
            */
        }

        function loadAsText(start = 0, end = 100) {
            let txt = "";
            for (let i = start; i < end; i++) {
                txt += String.fromCharCode(dataView.getInt8(i));
            }
            return txt;
        }

        function loadAsCode(start = 0, end = 100) {
            let txt = "";
            for (let i = start; i < end; i++) {
                txt += ("00000000" + dataView.getUint8(i).toString(2)).slice(-8) + " ";
            }
            return txt;
        }

        document.body.onload = () => {
            vConsole = new VConsole();
            //new MoveNode(new MoveNode())
        }
    </script>
</body>

</html>